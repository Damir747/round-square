# The Last of Guss

Браузерная игра, где игроки соревнуются, кто быстрее и больше натапает по виртуальному гусю, подхватившему мутацию G-42.

## Описание проекта

Игра представляет собой многопользовательское соревнование в реальном времени. Игроки могут участвовать в раундах, тапая по гусю для набора очков. Каждый раунд имеет ограниченное время, и победителем становится игрок с наибольшим количеством очков.

### Основные возможности

- **Система раундов**: Раунды имеют дату старта и завершения с настраиваемым cooldown и длительностью
- **Система очков**: 1 тап = 1 очко, каждый 11-й тап дает 10 очков
- **Роли пользователей**:
  - **Выживший** - может тапать и зарабатывать очки
  - **Никита** (nikita) - тапы не засчитываются в статистике (показываются нули)
  - **Администратор** (admin) - может создавать раунды
- **Активные раунды**: Тапать можно только в рамках активного раунда (между датой старта и завершения)
- **Масштабируемость**: Проект разработан с учетом возможности запуска нескольких инстансов бекенда

## Технологический стек

### Backend
- **Node.js** + **TypeScript** (strict mode)
- **Fastify** - веб-фреймворк
- **Prisma** - ORM для работы с базой данных
- **PostgreSQL** - база данных
- **JWT** - аутентификация через токены
- **bcrypt** - хеширование паролей

### Frontend
- **React** 19
- **TypeScript**
- **Vite** - сборщик и dev-сервер
- **React Router** - маршрутизация

## Структура проекта

```
round-square/
├── backend/              # Backend приложение
│   ├── src/
│   │   ├── controllers/ # Контроллеры для обработки запросов
│   │   ├── routes/      # Маршруты API
│   │   ├── services/    # Бизнес-логика
│   │   ├── plugins/     # Fastify плагины (CORS, cookies, Prisma)
│   │   ├── utils/       # Утилиты (JWT)
│   │   └── index.ts     # Точка входа
│   ├── prisma/
│   │   ├── schema.prisma # Схема базы данных
│   │   └── migrations/  # Миграции базы данных
│   └── package.json
├── frontend/            # Frontend приложение
│   ├── src/
│   │   ├── api/         # API клиент
│   │   ├── components/  # React компоненты
│   │   ├── pages/       # Страницы приложения
│   │   ├── hooks/       # React хуки
│   │   ├── utils/       # Утилиты
│   │   └── App.tsx      # Главный компонент
│   └── package.json
└── shared/              # Общие типы
    └── types.ts
```

## Установка и запуск

### Требования

- Node.js (версия 18 или выше)
- PostgreSQL (версия 12 или выше)
- npm или yarn

### Настройка базы данных

1. Создайте базу данных PostgreSQL:
```sql
CREATE DATABASE round_square;
```

2. Настройте переменные окружения в `backend/.env`:
```env
DATABASE_URL="postgresql://user:password@localhost:5432/round_square"
JWT_SECRET="your-secret-key-here"
ROUND_DURATION=60      # Длительность раунда в секундах
COOLDOWN_DURATION=30   # Cooldown перед стартом раунда в секундах
```

### Установка зависимостей

```bash
# Backend
cd backend
npm install

# Frontend
cd ../frontend
npm install
```

### Применение миграций

```bash
cd backend
npx prisma migrate deploy
# или для разработки
npx prisma migrate dev
```

### Запуск в режиме разработки

**Backend:**
```bash
cd backend
npm run dev
```
Сервер запустится на `http://localhost:3001`

**Frontend:**
```bash
cd frontend
npm run dev
```
Приложение будет доступно на `http://localhost:5173` (или другом порту, который выберет Vite)

### Сборка для продакшена

**Backend:**
```bash
cd backend
npm run build
npm start
```

**Frontend:**
```bash
cd frontend
npm run build
```
Собранные файлы будут в папке `frontend/dist`

## API Endpoints

### Аутентификация

- `POST /login` - Вход/регистрация пользователя
  - Body: `{ username: string, password: string }`
  - Создает пользователя, если его нет в базе
  - Возвращает JWT токен в cookie

- `GET /me` - Получение информации о текущем пользователе
  - Требует аутентификации (cookie с токеном)

- `POST /logout` - Выход из системы
  - Очищает cookie с токеном

### Раунды

- `GET /rounds` - Получение списка всех раундов
  - Возвращает массив раундов, отсортированных по дате старта (новые первые)

- `POST /rounds` - Создание нового раунда
  - Требует роль `admin`
  - Создает раунд с датой старта = текущее время + COOLDOWN_DURATION
  - Дата завершения = дата старта + ROUND_DURATION

- `GET /rounds/:id` - Получение информации о раунде
  - Возвращает статус раунда, очки текущего пользователя, победителя (если раунд завершен)
  - Статусы: `not_started`, `active`, `finished`

- `POST /rounds/:id/tap` - Тап по гусю
  - Требует аутентификации
  - Увеличивает счетчик тапов и очков
  - Проверяет, что раунд активен
  - Возвращает обновленные данные о тапах и очках пользователя

## База данных

### Модели

**User** - Пользователи системы
- `id` - уникальный идентификатор
- `username` - имя пользователя (уникальное)
- `password` - хешированный пароль
- `role` - роль: `survivor`, `admin`, `nikita`
- `createdAt` - дата создания

**Round** - Раунды игры
- `id` - уникальный идентификатор
- `name` - название раунда (генерируется автоматически как "Round {id}")
- `startAt` - дата и время старта
- `endAt` - дата и время завершения
- `taps` - общее количество тапов в раунде
- `points` - общее количество очков в раунде
- `createdAt` - дата создания

**RoundUser** - Связь пользователя с раундом (статистика)
- `roundId` - ID раунда
- `userId` - ID пользователя
- `taps` - количество тапов пользователя в раунде
- `points` - количество очков пользователя в раунде
- Составной первичный ключ: `[roundId, userId]`

## Особенности реализации

### Консистентность данных

Для обеспечения корректности данных при одновременных тапах используется транзакция Prisma (`$transaction`). Это гарантирует:
- Атомарность операций увеличения счетчиков
- Корректный расчет очков (учет бонуса за 11-й тап)
- Проверку активности раунда в момент тапа
- Защиту от race conditions

### Система ролей

Роли назначаются автоматически при создании пользователя:
- Если `username === "admin"` → роль `admin`
- Если `username.toLowerCase() === "никита"` → роль `nikita`
- Иначе → роль `survivor`

### Особенность роли "Никита"

Пользователи с ролью `nikita` могут тапать, но их тапы:
- Не засчитываются в их личную статистику (показываются нули)
- Не увеличивают общий счетчик очков раунда
- Увеличивают только общий счетчик тапов раунда

### Масштабируемость

Проект разработан с учетом горизонтального масштабирования:
- Stateless бекенд (JWT токены в cookies)
- Нет привязки пользователя к конкретному инстансу
- Транзакции базы данных обеспечивают консистентность при работе нескольких инстансов
- Возможна конфигурация: 1 база данных, 1 reverse proxy, N бекенд-инстансов

## Страницы фронтенда

1. **Логин** (`/` или `/login`)
   - Форма входа с полями username и password
   - Автоматическая регистрация при первом входе
   - Отображение ошибки при неверном пароле

2. **Список раундов** (`/rounds`)
   - Отображение всех раундов (активных, запланированных, завершенных)
   - ID раунда - ссылка на страницу раунда
   - Кнопка "Создать раунд" (только для админов)
   - При создании раунда автоматический переход на страницу раунда

3. **Страница раунда** (`/round/:id`)
   - Отображение статуса раунда (не начат / активен / завершен)
   - Таймер обратного отсчета
   - Интерактивный гусь для тапов (только если раунд активен)
   - Отображение собственных очков
   - Отображение победителя (если раунд завершен)

## Принципы разработки

- **SOLID** - код структурирован с соблюдением принципов SOLID
- **TypeScript strict mode** - строгая типизация для надежности
- **Разделение ответственности** - контроллеры, сервисы, роуты разделены
- **Транзакции** - использование транзакций БД для консистентности
- **Обработка ошибок** - корректная обработка и возврат ошибок клиенту

## Разработка

### Генерация Prisma Client

После изменения схемы базы данных:
```bash
cd backend
npx prisma generate
```

### Создание миграции

```bash
cd backend
npx prisma migrate dev --name migration_name
```

### Просмотр базы данных

```bash
cd backend
npx prisma studio
```


